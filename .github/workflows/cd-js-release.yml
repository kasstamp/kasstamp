name: CD - JS Release

on:
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'
  REGISTRY: 'registry.gitlab.com'
  IMAGE_NAME: 'registry.gitlab.com/kasdag/kasstamp_web'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from package.json
        id: version
        run: |
          # Get version from js/package.json (main version)
          VERSION=$(node -p "require('./web/package.json').version")
          echo "ðŸ“¦ Detected version: ${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create release tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v${VERSION}"

          # Check if tag already exists
          if git tag -l "${TAG}" | grep -q "${TAG}"; then
            echo "âš ï¸ Tag ${TAG} already exists, skipping creation"
          else
            echo "ðŸ·ï¸ Creating release tag ${TAG} on main branch"
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git tag -a "${TAG}" -m "Release ${TAG}"
            git push origin "${TAG}"
            echo "âœ… Tag ${TAG} created and pushed"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            js/package-lock.json
            web/package-lock.json

      - name: Install JS packages dependencies
        working-directory: js
        run: npm ci

      - name: Build JS packages
        working-directory: js
        run: |
          echo "ðŸ”¨ Building JS packages..."
          npm run build

      - name: Install web dependencies
        working-directory: web
        run: |
          echo "ðŸ“¦ Installing web dependencies..."
          # Run npm install to ensure package-lock.json is up to date
          # This syncs dependencies from JS packages that might have been updated
          npm install
          echo "âœ… Web dependencies installed"

      - name: Build web application
        working-directory: web
        env:
          NODE_ENV: production
        run: |
          echo "ðŸ”¨ Building web application for production..."
          npm run build
          echo "âœ… Web build complete"
          ls -lh dist/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitLab Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.GITLAB_REGISTRY_USER }}
          password: ${{ secrets.GITLAB_REGISTRY_TOKEN }}

      - name: Build and push Docker image
        working-directory: web
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          echo "ðŸ³ Building production Docker image..."
          echo "   Version: ${VERSION}"
          echo "   Image: ${{ env.IMAGE_NAME }}"

          docker buildx build \
            --platform linux/amd64 \
            -t ${{ env.IMAGE_NAME }}:${VERSION} \
            -t ${{ env.IMAGE_NAME }}:latest \
            --push \
            .

          echo "ðŸ“¤ Image built and pushed to GitLab Registry!"

          echo "âœ… Docker image pushed successfully!"
          echo "   ${{ env.IMAGE_NAME }}:${VERSION}"
          echo "   ${{ env.IMAGE_NAME }}:latest"

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CURRENT_TAG="v${VERSION}"
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "changelog=Initial release" >> $GITHUB_OUTPUT
            echo "prev_tag=" >> $GITHUB_OUTPUT
          else
            # Use the recommended "delimiter" method for multi-line strings
            # instead of URL encoding. This preserves newlines.
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "${CHANGELOG}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "prev_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v${VERSION}"
          CHANGELOG="${{ steps.changelog.outputs.changelog }}"
          PREV_TAG="${{ steps.changelog.outputs.prev_tag }}"
          IMAGE_NAME="${{ env.IMAGE_NAME }}"
          REPO="${{ github.repository }}"

          if [ -z "$PREV_TAG" ]; then
            COMPARE_URL="**Full Changelog**: https://github.com/${REPO}/commits/${TAG}"
          else
            COMPARE_URL="**Full Changelog**: https://github.com/${REPO}/compare/${PREV_TAG}...${TAG}"
          fi

          cat > release_body.md << EOF
          ## ðŸš€ KasStamp Web v${VERSION}

          ### ðŸ“ Changes
          ${CHANGELOG}

          ---

          ${COMPARE_URL}
          EOF

          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "âš ï¸ Release ${TAG} already exists, skipping creation"
          else
            echo "âœ… Creating new release ${TAG}"
            gh release create "${TAG}" \
              --title "KasStamp v${VERSION}" \
              --notes-file release_body.md
          fi

      - name: Release Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          echo "## ðŸŽ‰ Release v${VERSION} Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Version" >> $GITHUB_STEP_SUMMARY
          echo "**${VERSION}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ³ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME }}:${VERSION}\` (release)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME }}:latest\` (updated)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Deploy to Production" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.IMAGE_NAME }}:${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "docker stop kasstamp-web && docker rm kasstamp-web" >> $GITHUB_STEP_SUMMARY
          echo "docker run -d --name kasstamp-web --network web --restart unless-stopped ${{ env.IMAGE_NAME }}:${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/tag/v${VERSION}" >> $GITHUB_STEP_SUMMARY
