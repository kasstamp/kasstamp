name: Security & Dependencies

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: write
  checks: write
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '22.x'

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache JS dependencies
        uses: actions/cache@v4
        with:
          path: js/node_modules
          key: ${{ runner.os }}-js-node-modules-${{ hashFiles('js/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-js-node-modules-

      - name: Cache Web dependencies
        uses: actions/cache@v4
        with:
          path: web/node_modules
          key: ${{ runner.os }}-web-node-modules-${{ hashFiles('web/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-web-node-modules-

      - name: Install JS dependencies
        run: |
          cd js
          npm ci

      - name: Install Web dependencies
        run: |
          cd web
          npm ci

      - name: Audit JS packages
        id: js-audit
        run: |
          cd js
          npm run audit:all

      - name: Audit Web package
        id: web-audit
        run: |
          cd web
          npm audit --audit-level=moderate

      - name: Create Security Report
        if: failure() && (steps.js-audit.outcome == 'failure' || steps.web-audit.outcome == 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report = '# Security Audit Report\n\n';
            report += `**Run Date:** ${new Date().toISOString()}\n`;
            report += `**Commit:** ${context.sha}\n`;
            report += `**Branch:** ${context.ref.replace('refs/heads/', '')}\n\n`;

            report += '## ‚ö†Ô∏è Security Vulnerabilities Found\n\n';
            report += 'The security audit detected vulnerabilities that need to be addressed:\n\n';

            if ('${{ steps.js-audit.outcome }}' === 'failure') {
              report += '### JS Packages (Monorepo)\n';
              report += 'Security vulnerabilities were found in the JS packages.\n\n';
            }

            if ('${{ steps.web-audit.outcome }}' === 'failure') {
              report += '### Web Package\n';
              report += 'Security vulnerabilities were found in the Web package.\n\n';
            }

            report += '## üîß Recommended Actions\n\n';
            report += '1. Run `npm audit fix` to automatically fix vulnerabilities\n';
            report += '2. Review and update dependencies manually if needed\n';
            report += '3. Test thoroughly after applying fixes\n';
            report += '4. Re-run the security audit to verify fixes\n\n';

            fs.writeFileSync('security-report.md', report);
            console.log('‚ö†Ô∏è Security report created - vulnerabilities found');

      - name: Upload Security Report
        if: failure() && (steps.js-audit.outcome == 'failure' || steps.web-audit.outcome == 'failure')
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.run_number }}
          path: security-report.md
          retention-days: 30

      - name: Comment PR with Security Report
        if: github.event_name == 'pull_request' && failure() && (steps.js-audit.outcome == 'failure' || steps.web-audit.outcome == 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (fs.existsSync('security-report.md')) {
              const report = fs.readFileSync('security-report.md', 'utf8');

              const comment =
                report +
                '\n\n---\n*This report was automatically generated by the Security workflow due to vulnerabilities found.*';

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment,
              });
            }

  dependabot-check:
    name: Dependabot Security Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.actor == 'dependabot[bot]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Dependabot Security Status
        uses: actions/github-script@v7
        with:
          script: |
            const isDependabot = context.actor === 'dependabot[bot]';

            if (isDependabot) {
              console.log('‚úÖ Dependabot PR detected');

              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });

              const title = pr.title.toLowerCase();
              const isSecurityUpdate =
                title.includes('security') ||
                title.includes('vulnerability') ||
                title.includes('cve');

              if (isSecurityUpdate) {
                console.log('üîí Security update detected - high priority');

                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['security', 'dependencies', 'high-priority'],
                });

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body:
                    'üîí **Security Update Detected**\n\n' +
                    'This Dependabot PR addresses security vulnerabilities. Please review and merge promptly.\n\n' +
                    '**Priority:** High\n**Type:** Security Update\n**Auto-generated by:** Dependabot\n\n' +
                    'Please test thoroughly before merging.',
                });
              } else {
                console.log('üì¶ Regular dependency update');

                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['dependencies'],
                });
              }
            } else {
              console.log('‚ÑπÔ∏è Regular PR - not from Dependabot');
            }
